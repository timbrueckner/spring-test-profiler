<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="${'Spring Test Profiler Report'}">
    Spring Test Profiler Report</title>
  <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ§ª</text></svg>">
  <script src="https://d3js.org/d3.v7.min.js" integrity="sha384-CjloA8y00+1SDAUkjs099PVfnY2KmDC2BZnws9kh8D/lX1s46w6EPhpXdqMfjK6i" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/diff@5.2.0/dist/diff.min.js" integrity="lJJVaUgxmk/PVfQnAsGN1QuJZrE+n6bg2EMu33yVZOJ2av/3UzTHbmnPCI7ENJYa" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="static/css/spring-test-profiler.css">
</head>
<body>
<div class="container">
  <h1 th:text="${'Spring Test Profiler Report'}">
    Spring Test Profiler Report</h1>
  <p>Understanding when and how many Spring ApplicationContexts are created in your test suite allows you to optimize
    build times by leveraging Spring TestContext's context caching feature, which reuses already started contexts.</p>
  <br/>
  <div class="timestamp" th:text="${'Generated at: ' + generatedAt}">Generated at: 2025-01-01 12:00:00</div>

  <!-- Theory Section Fragment -->
  <div th:replace="~{fragments/theory :: theory-section}"></div>

  <!-- Summary Section Fragment -->
  <div th:replace="~{fragments/summary :: summary-section(${executionTracker}, ${cacheStats})}"></div>

  <!-- Context Caching Statistics Fragment -->
  <div th:replace="~{fragments/caching :: caching-section(${cacheStats}, ${contextCacheTracker})}"></div>

  <!-- Context Comparison Visualizer Fragment -->
  <div th:replace="~{fragments/context-comparison :: context-comparison-section}"></div>

  <!-- Optimization Recommendations Fragment -->
  <!--  <div th:replace="~{fragments/optimization :: optimization-section(${optimizationStats})}"></div>-->

  <!-- Timeline Visualization Fragment -->
  <!--  <div th:replace="~{fragments/timeline :: timeline-section(${timelineData}, ${jsonHelper})}"></div>-->

  <!-- Context Configurations Fragment -->
  <div th:replace="~{fragments/configurations :: configurations-section}"></div>

  <!-- Test Execution Details Fragment -->
  <div th:replace="~{fragments/test-execution :: test-execution-section(${executionTracker})}"></div>

</div>

<!-- Footer -->
<footer class="footer">
  <div class="footer-content">
    <p>
      Get help with optimizing your Spring Boot test suite at
      <a th:href="@{'https://pragmatech.digital' + ${utmParameters}}" target="_blank" rel="noopener noreferrer">
        PragmaTech GmbH
      </a>
    </p>
    <p>
      Generated on <span th:text="${generatedAt}">2025-01-01 12:00:00</span>
      by <strong>Spring Test Profiler</strong>
      <span th:text="${extensionVersion}">v0.0.1-SNAPSHOT</span>
    </p>
    <p>
      <a href="https://github.com/PragmaTech-GmbH/spring-test-profiler" target="_blank"
         rel="noopener noreferrer">GitHub</a>
      |
      <a th:href="@{'https://pragmatech.digital/products/' + ${utmParameters}}" target="_blank" rel="noopener noreferrer">Documentation</a>
      |
      <a href="https://github.com/PragmaTech-GmbH/spring-test-profiler/issues" target="_blank"
         rel="noopener noreferrer">Submit a Bug or Feature Request</a>
    </p>
  </div>
</footer>

<script type="application/json" id="context-statistics-json" th:utext="${contextStatisticsJson}">[]</script>
<script src="static/js/report.js"></script>
<script>
    function changeSortOption() {
        const sortOption = document.getElementById('sortOption').value;
        const testClassContainer = findTestExecutionSection();
        
        if (!testClassContainer) return;

        const testClasses = Array.from(testClassContainer.querySelectorAll('div.test-class[data-duration]'));
        sortAndReorderElements(testClasses, testClassContainer, sortOption);
    }

    function findTestExecutionSection() {
        const headers = document.querySelectorAll('h2');
        for (const header of headers) {
            if (header.textContent.trim() === 'Test Execution Details') {
                return header.parentElement;
            }
        }
        return null;
    }

    function sortAndReorderElements(testClasses, container, sortOption) {
        // Sort test classes
        testClasses.sort((a, b) => getSortComparison(a, b, sortOption));

        // Re-append test classes and sort their methods
        testClasses.forEach(testClass => {
            container.appendChild(testClass);
            sortTestMethods(testClass, sortOption);
        });
    }

    function sortTestMethods(testClass, sortOption) {
        const testMethods = Array.from(testClass.querySelectorAll('.test-method'));
        const testMethodsContainer = testClass.querySelector('.test-methods');

        if (testMethodsContainer && testMethods.length > 0) {
            testMethods.sort((a, b) => getSortComparison(a, b, sortOption));
            testMethods.forEach(testMethod => testMethodsContainer.appendChild(testMethod));
        }
    }

    function getSortComparison(a, b, sortOption) {
        switch (sortOption) {
            case 'duration':
                return parseInt(b.dataset.duration || '0') - parseInt(a.dataset.duration || '0');
            case 'name':
                return (a.dataset.name || '').localeCompare(b.dataset.name || '');
            case 'failed':
                const aFailed = parseInt(a.dataset.failed || '0');
                const bFailed = parseInt(b.dataset.failed || '0');
                if (aFailed !== bFailed) {
                    return bFailed - aFailed; // Failed first
                }
                // If same failed count, sort by duration descending
                return parseInt(b.dataset.duration || '0') - parseInt(a.dataset.duration || '0');
            default:
                return 0;
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const sortSelect = document.getElementById('sortOption');
        if (sortSelect) {
            sortSelect.value = 'duration';
        }
    });
</script>
</body>
</html>
